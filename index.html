<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Auth | UniRate</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin: 24px; }
    .card { max-width: 420px; margin: 0 auto; border: 1px solid #ddd; padding: 20px; border-radius: 8px; }
    h3 { margin-top: 0; }
    input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 6px; }
    button { width: 100%; padding: 10px; border: 0; border-radius: 6px; cursor: pointer; }
    .primary { background: #0d2c54; color: #fff; }
    .link { margin-top: 10px; display: block; text-align: center; }
    .ok { color: #0a7a0a; }
    .err { color: #a00; }
    .muted { color: #666; font-size: 0.95em; }
  </style>
</head>
<body>
  <div class="card">
    <h3 id="title">Procesando…</h3>
    <p id="desc" class="muted">Espera un momento.</p>

    <div id="recovery" style="display:none;">
      <input id="pwd1" type="password" placeholder="Nueva contraseña" autocomplete="new-password" />
      <input id="pwd2" type="password" placeholder="Repite la contraseña" autocomplete="new-password" />
      <button id="save" class="primary">Guardar contraseña</button>
      <p id="msg" class="muted"></p>
    </div>

    <div id="done" style="display:none;">
      <p id="doneMsg" class="ok">Listo.</p>
      <!-- Opcional: volver a la app nativa si tienes deep link propio -->
      <!-- <a id="openApp" class="link" href="myapp://auth-callback">Volver a la app</a> -->
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // ==== CONFIG ====
    const SUPABASE_URL = 'https://hsiwcusolcaicuxhnkcb.supabase.co';
    const SUPABASE_ANON_KEY = 'SUPABASE_CLIENT_API_KEY'; // copia literal del panel
    // Opcional: deep link de tu app si quieres botón "Abrir app"
    const APP_DEEP_LINK = null; // p.ej. 'myapp://auth-callback' o 'exp://127.0.0.1:19000'

    const sp = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Supabase usa fragmento hash tras '#'. Lo convertimos a query para fácil lectura.
    const hash = location.hash.startsWith('#') ? location.hash.slice(1) : '';
    const merged = new URLSearchParams(hash); // tokens suelen venir en el hash
    // También consideramos querystring normal (?flow=google)
    const qs = new URLSearchParams(location.search);
    for (const [k, v] of qs.entries()) if (!merged.has(k)) merged.set(k, v);

    const byId = (id) => document.getElementById(id);
    const show = (id, vis) => byId(id).style.display = vis ? 'block' : 'none';

    async function ensureSessionFromSupabaseParams() {
  const access_token = merged.get('access_token');
  const refresh_token = merged.get('refresh_token') || null;
  const code  = merged.get('code');
  const token = merged.get('token');
  const type  = merged.get('type'); // 'signup' | 'invite' | 'email_change' | 'recovery'
  const flow  = merged.get('flow');

  try {
    if (access_token) {
      const { error } = await sp.auth.setSession({ access_token, refresh_token });
      if (error) throw error;

      if (type === 'recovery') {
        byId('title').textContent = 'Restablecer contraseña';
        byId('desc').textContent = 'Ingresa tu nueva contraseña.';
        show('recovery', true);
        return;
      }

      byId('title').textContent = 'Autenticación completada';
      byId('desc').textContent = 'Tu usuario ya fue autenticado. Puedes ingresar en la app.';
      show('done', true);
      cleanUrl();
      return;
    }

    if (code) {
      const { error } = await sp.auth.exchangeCodeForSession(code);
      if (error) throw error;

      byId('title').textContent = 'Autenticación completada';
      byId('desc').textContent = 'Tu usuario ya fue autenticado. Puedes ingresar en la app.';
      show('done', true);
      cleanUrl();
      return;
    }

    if (token && (type === 'signup' || type === 'invite' || type === 'email_change')) {
      const { error } = await sp.auth.verifyOtp({ type: 'email', token_hash: token });
      if (error) throw error;

      byId('title').textContent = 'Correo verificado';
      byId('desc').textContent = 'Tu usuario ya fue autenticado. Puedes ingresar en la app.';
      show('done', true);
      cleanUrl();
      return;
    }

    // Recuperación vía token_hash (algunos correos llegan así)
    if (token && type === 'recovery') {
      const { error } = await sp.auth.verifyOtp({ type: 'recovery', token_hash: token });
      if (error) throw error;
      byId('title').textContent = 'Restablecer contraseña';
      byId('desc').textContent = 'Ingresa tu nueva contraseña.';
      show('recovery', true);
      cleanUrl();
      return;
    }

    byId('title').textContent = 'Enlace inválido o expirado';
    byId('desc').textContent = 'Solicita un nuevo enlace desde la app.';
  } catch (err) {
    byId('title').textContent = 'No se pudo completar la autenticación';
    byId('desc').textContent = String(err.message || err);
  }
}


    function validatePassword(pwd) {
  // ≥8 chars, 1 mayúscula, 1 número, 1 especial
  return /^(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_\-+=\[\]{};:'",.<>?/\\|`~]).{8,}$/.test(pwd);
}

    async function saveNewPassword() {
      const p1 = byId('pwd1').value.trim();
      const p2 = byId('pwd2').value.trim();
      const msg = byId('msg');
      const btn = byId('save');

      msg.className = 'muted';
      if (!p1 || !p2) { msg.textContent = 'Completa ambos campos.'; return; }
      if (p1 !== p2) { msg.textContent = 'Las contraseñas no coinciden.'; return; }
      if (!validatePassword(p1)) {
        msg.textContent = 'Mín. 8, 1 mayúscula, 1 número y 1 caracter especial.';
        return;
      }

      btn.disabled = true; btn.textContent = 'Guardando…'; msg.textContent = '';
      const { error } = await sp.auth.updateUser({ password: p1 });
      btn.disabled = false; btn.textContent = 'Guardar contraseña';

      if (error) { msg.className = 'err'; msg.textContent = error.message; return; }

      msg.className = 'ok'; msg.textContent = 'Contraseña actualizada.';
      show('recovery', false);
      byId('doneMsg').textContent = 'Contraseña actualizada. Ya puedes ingresar en la app.';
      show('done', true);
      cleanUrl();
    }

    byId('save').addEventListener('click', saveNewPassword);

['pwd1','pwd2'].forEach(id => {
  byId(id).addEventListener('keydown', (e) => {
    if (e.key === 'Enter') saveNewPassword();
  });
});

    // Ejecuta
    ensureSessionFromSupabaseParams();

    function cleanUrl() {
  const url = new URL(location.href);
  url.hash = '';
  url.search = '';
  history.replaceState({}, document.title, url.toString());
}

  </script>
</body>
</html>

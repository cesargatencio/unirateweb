<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Auth | UniRate</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin: 24px; }
    .card { max-width: 420px; margin: 0 auto; border: 1px solid #ddd; padding: 20px; border-radius: 8px; }
    h3 { margin-top: 0; }
    input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 6px; }
    button { width: 100%; padding: 10px; border: 0; border-radius: 6px; cursor: pointer; }
    .primary { background: #0d2c54; color: #fff; }
    .link { margin-top: 10px; display: block; text-align: center; }
    .ok { color: #0a7a0a; }
    .err { color: #a00; }
    .muted { color: #666; font-size: 0.95em; }
  </style>
</head>
<body>
  <div class="card">
    <h3 id="title">Procesando…</h3>
    <p id="desc" class="muted">Espera un momento.</p>

    <div id="otp" style="display:none;">
      <input id="otpEmail" type="email" placeholder="Tu correo" autocomplete="email" />
      <input id="otpCode" type="text" placeholder="Código de 6 dígitos" inputmode="numeric" />
      <button id="otpBtn" class="primary">Verificar código</button>
      <p id="otpMsg" class="muted"></p>
    </div>

    <div id="recovery" style="display:none;">
      <input id="pwd1" type="password" placeholder="Nueva contraseña" autocomplete="new-password" />
      <input id="pwd2" type="password" placeholder="Repite la contraseña" autocomplete="new-password" />
      <button id="save" class="primary">Guardar contraseña</button>
      <p id="msg" class="muted"></p>
    </div>

    <div id="done" style="display:none;">
      <p id="doneMsg" class="ok">Listo.</p>
      <!-- Opcional: volver a la app nativa si tienes deep link propio -->
      <!-- <a id="openApp" class="link" href="myapp://auth-callback">Volver a la app</a> -->
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // ==== CONFIG ====
    const SUPABASE_URL = 'https://hsiwcusolcaicuxhnkcb.supabase.co';
    // REPLACE the placeholder below with your real Client API Key (anon public key) from the Supabase panel
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhzaXdjdXNvbGNhaWN1eGhua2NiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNjM4ODIsImV4cCI6MjA3NDgzOTg4Mn0.47wIP77NwDL01W3jAVFNTn4y8l7p8zmFt84kig3FVvo';

    // Opcional: deep link de tu app si quieres botón "Abrir app"
    const APP_DEEP_LINK = null; // p.ej. 'myapp://auth-callback' o 'exp://127.0.0.1:19000'

    // --- crear cliente (evita export / process.env en navegador) ---
    const sp = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { detectSessionInUrl: false, autoRefreshToken: true, persistSession: true }
    });

    // Supabase usa fragmento hash tras '#'. Lo convertimos a query para fácil lectura.
    const hash = location.hash.startsWith('#') ? location.hash.slice(1) : '';
    const merged = new URLSearchParams(hash); // tokens suelen venir en el hash
    // También consideramos querystring normal (?flow=google)
    const qs = new URLSearchParams(location.search);
    for (const [k, v] of qs.entries()) if (!merged.has(k)) merged.set(k, v);

    const byId = (id) => document.getElementById(id);
    const show = (id, vis) => byId(id).style.display = vis ? 'block' : 'none';

    async function ensureSessionFromSupabaseParams() {
      const access_token = merged.get('access_token');
      const refresh_token = merged.get('refresh_token') || null;
      const code  = merged.get('code');
      const token = merged.get('token');
      const type  = merged.get('type'); // 'signup' | 'invite' | 'email_change' | 'recovery'
      const flow  = merged.get('flow');

      try {
        // 1) Link con access_token (incluye recovery)
        if (access_token) {
          const { error } = await sp.auth.setSession({ access_token, refresh_token });
          if (error) throw error;

          // Validación extra tras crear sesión
          const { error: meErr } = await sp.auth.getUser();
          if (meErr) throw meErr;

          if (type === 'recovery') {
            byId('title').textContent = 'Restablecer contraseña';
            byId('desc').textContent = 'Ingresa tu nueva contraseña.';
            show('recovery', true);
            return;
          }
          byId('title').textContent = 'Autenticación completada';
          byId('desc').textContent = 'Tu usuario ya fue autenticado. Puedes ingresar en la app.';
          show('done', true);
          cleanUrl();
          return;
        }

        // 2) PKCE
        if (code) {
          const { error } = await sp.auth.exchangeCodeForSession(code);
          if (error) throw error;
          byId('title').textContent = 'Autenticación completada';
          byId('desc').textContent = 'Tu usuario ya fue autenticado. Puedes ingresar en la app.';
          show('done', true);
          cleanUrl();
          return;
        }

        // 3a) Recuperación vía token_hash (algunos correos llegan así)
        if (token && type === 'recovery') {
          const { error } = await sp.auth.verifyOtp({ type: 'recovery', token_hash: token });
          if (error) throw error;
          byId('title').textContent = 'Restablecer contraseña';
          byId('desc').textContent = 'Ingresa tu nueva contraseña.';
          show('recovery', true);
          cleanUrl();
          return;
        }

        // 3b) token_hash desde link (signup / email_change / invite)
        if (token && (type === 'signup' || type === 'email_change' || type === 'invite')) {
          const { error } = await sp.auth.verifyOtp({ type: 'email', token_hash: token });
          if (error) throw error;
          byId('title').textContent = 'Correo verificado';
          byId('desc').textContent = 'Tu usuario ya fue autenticado. Puedes ingresar en la app.';
          show('done', true);
          cleanUrl();
          return;
        }

        // 4) Sin tokens: muestra entrada de código OTP
        byId('title').textContent = 'Restablecer contraseña';
        byId('desc').textContent = 'Ingresa el código de 6 dígitos del correo y tu email.';
        show('otp', true);
      } catch (err) {
        console.error(err);
        byId('title').textContent = 'No se pudo completar la autenticación';
        byId('desc').textContent = (err?.message || '').includes('Failed to fetch')
          ? 'Error de red o CORS. Verifica Redirect URLs y CORS en Supabase.'
          : String(err?.message || err);
      }
    }

    function validatePassword(pwd) {
      // ≥8 chars, 1 mayúscula, 1 número, 1 especial
      return /^(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_\-+=\[\]{};:'",.<>?/\\|`~]).{8,}$/.test(pwd);
    }

    async function verifyOtpCodeFlow() {
      const email = byId('otpEmail').value.trim();
      const code = byId('otpCode').value.trim();
      const msg  = byId('otpMsg');
      const btn  = byId('otpBtn');

      msg.className = 'muted';
      if (!email) { msg.textContent = 'Ingresa tu correo.'; return; }
      if (!/^\d{6}$/.test(code)) { msg.textContent = 'Ingresa el código de 6 dígitos.'; return; }

      btn.disabled = true; btn.textContent = 'Verificando…'; msg.textContent = '';
      const { data, error } = await sp.auth.verifyOtp({
        email,
        token: code,           // <-- código de 6 dígitos
        type: 'recovery'       // <-- tipo correcto
      });
      btn.disabled = false; btn.textContent = 'Verificar código';

      if (error) { msg.className = 'err'; msg.textContent = error.message; return; }

      // Si el verifyOtp inicia sesión, ya podemos mostrar el formulario de nueva clave
      byId('title').textContent = 'Restablecer contraseña';
      byId('desc').textContent = 'Ingresa tu nueva contraseña.';
      show('otp', false);
      show('recovery', true);
      cleanUrl();
    }

    async function saveNewPassword() {
      const p1 = byId('pwd1').value.trim();
      const p2 = byId('pwd2').value.trim();
      const msg = byId('msg');
      const btn = byId('save');

      msg.className = 'muted';
      if (!p1 || !p2) { msg.textContent = 'Completa ambos campos.'; return; }
      if (p1 !== p2) { msg.textContent = 'Las contraseñas no coinciden.'; return; }
      if (!validatePassword(p1)) {
        msg.textContent = 'Mín. 8, 1 mayúscula, 1 número y 1 caracter especial.';
        return;
      }

      btn.disabled = true; btn.textContent = 'Guardando…'; msg.textContent = '';
      const { error } = await sp.auth.updateUser({ password: p1 });
      btn.disabled = false; btn.textContent = 'Guardar contraseña';

      if (error) { msg.className = 'err'; msg.textContent = error.message; return; }

      msg.className = 'ok'; msg.textContent = 'Contraseña actualizada.';
      show('recovery', false);
      byId('doneMsg').textContent = 'Contraseña actualizada. Ya puedes ingresar en la app.';
      show('done', true);
      cleanUrl();
    }

    byId('save').addEventListener('click', saveNewPassword);

    byId('otpBtn').addEventListener('click', verifyOtpCodeFlow);
    ['otpEmail','otpCode'].forEach(id => {
      byId(id).addEventListener('keydown', (e) => { if (e.key === 'Enter') verifyOtpCodeFlow(); });
    });

    ['pwd1','pwd2'].forEach(id => {
      byId(id).addEventListener('keydown', (e) => {
        if (e.key === 'Enter') saveNewPassword();
      });
    });

    // Ejecuta
    ensureSessionFromSupabaseParams();

    function cleanUrl() {
      const url = new URL(location.href);
      url.hash = '';
      url.search = '';
      history.replaceState({}, document.title, url.toString());
    }

  </script>
</body>
</html>
